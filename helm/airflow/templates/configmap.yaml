apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-config
  namespace: airflow
data:
  # =========================
  # Core
  # =========================
  AIRFLOW__CORE__EXECUTOR: CeleryExecutor
  AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
  AIRFLOW__CORE__LOAD_EXAMPLES: "False"
  AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "True"

  # REQUIRED for Airflow 3.x (do NOT remove)
  AIRFLOW__CORE__EXECUTION_API_SERVER_URL: http://airflow-api.airflow.svc.cluster.local:8080/execution/

  # =========================
  # Authentication
  # =========================
  AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
  AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth

  # =========================
  # Logging (FINAL FIX)
  # =========================
  # ❌ Disable served logs (THIS IS THE BUG)
  AIRFLOW__LOGGING__USE_SERVED_LOGS: "False"

  # ✅ Enable remote logging (STABLE)
  AIRFLOW__LOGGING__REMOTE_LOGGING: "True"
  AIRFLOW__LOGGING__LOGGING_LEVEL: "INFO"

  # ===== Choose ONE backend =====
  # ---- S3 example ----
  AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER: s3://airflow-logs-bucket/logs
  AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID: aws_default

  # (DO NOT set WORKER_LOG_SERVER_HOST or PORT)

  # =========================
  # Web / API
  # =========================
  AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX: "True"
  AIRFLOW__WEBSERVER__BASE_URL: https://airflow.pushparag.online

  # =========================
  # Hostname (SAFE)
  # =========================
  AIRFLOW__CORE__HOSTNAME_CALLABLE: airflow.utils.net.get_host_ip_address
  AIRFLOW__API__HOSTNAME_CALLABLE: airflow.utils.net.get_host_ip_address
  AIRFLOW__LOGGING__HOSTNAME_CALLABLE: airflow.utils.net.get_host_ip_address

  # =========================
  # Misc
  # =========================
  PYTHONPATH: /opt/airflow