apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-worker
  namespace: airflow
spec:
  replicas: {{ .Values.replicaCount.worker }}
  selector:
    matchLabels:
      app: airflow-worker

  template:
    metadata:
      labels:
        app: airflow-worker

    spec:
      serviceAccountName: airflow-sa

      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}

      # ⭐ CRITICAL FIX
      securityContext:
        fsGroup: 50000

      volumes:
        - name: logs
          persistentVolumeClaim:
            claimName: airflow-logs

      # ⭐ FIX PERMISSIONS BEFORE WORKER STARTS
      initContainers:
        - name: fix-permissions
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          command:
            - /bin/bash
            - -c
            - |
              mkdir -p /opt/airflow/logs
              chown -R 50000:50000 /opt/airflow/logs
              chmod -R 775 /opt/airflow/logs
          volumeMounts:
            - name: logs
              mountPath: /opt/airflow/logs
          securityContext:
            runAsUser: 0

      containers:
        - name: worker
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          command: ["/entrypoint"]
          args: ["airflow", "celery", "worker"]

          volumeMounts:
            - name: logs
              mountPath: /opt/airflow/logs

          envFrom:
            - configMapRef:
                name: airflow-config
            - secretRef:
                name: airflow-secret